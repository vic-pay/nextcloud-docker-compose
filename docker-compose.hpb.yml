services:

  # NGINX - reverse proxy with ssl
  nextcloud-nginx:
    image: nginx:alpine
    container_name: nextcloud-nginx
    hostname:       nextcloud-nginx
    volumes:
      - type: bind
        source: ./config/nginx.conf
        target:  /etc/nginx/conf.d/default.conf
        read_only: true

      - type: volume
        source: nextcloud-app-volume
        target: /var/www/html
        read_only: true
      
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

      - type: bind
        source: /etc/timezone
        target: /etc/timezone
        read_only: true

      - type: bind
        source: ./ssl
        target:  /etc/nginx/ssl
        read_only: true

    network_mode: host
    depends_on: ['nextcloud-app']
    restart: unless-stopped

  # NEXTCLOUD - app
  nextcloud-app:
    image: nextcloud:fpm-alpine
    container_name: nextcloud-app
    hostname:       nextcloud-app
    environment:
      NEXTCLOUD_TRUSTED_DOMAINS: localhost payva-u.yooteam.ru
      NEXTCLOUD_ADMIN_USER:      admin
      NEXTCLOUD_ADMIN_PASSWORD: $NEXTCLOUD_ADMIN_PASSWORD
      POSTGRES_HOST:             localhost
      POSTGRES_DB:              $POSTGRES_DB
      POSTGRES_USER:            $POSTGRES_USER
      POSTGRES_PASSWORD:        $POSTGRES_PASSWORD
      REDIS_HOST:                localhost
    volumes:
      - type: volume
        source: nextcloud-app-volume
        target: /var/www/html
        read_only: false

      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

      - type: bind
        source: /etc/timezone
        target: /etc/timezone
        read_only: true

    network_mode: host
    depends_on: ['nextcloud-postgres', 'nextcloud-redis']
    restart: unless-stopped

  # POSTGRES - db
  nextcloud-postgres:
    image: postgres:alpine
    container_name: nextcloud-postgres
    hostname:       nextcloud-postgres
    environment:
      POSTGRES_DB:       $POSTGRES_DB
      POSTGRES_USER:     $POSTGRES_USER
      POSTGRES_PASSWORD: $POSTGRES_PASSWORD
    volumes:
      - type: volume
        source: nextcloud-postgres-volume
        target: /var/lib/postgresql/data
        read_only: false

      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

      - type: bind
        source: /etc/timezone
        target: /etc/timezone
        read_only: true

      - type: bind
        source: ./ssl
        target:  /var/lib/postgresql/ssl
        read_only: true

      - type: bind
        source: ./config/postgres
        target:  /docker-entrypoint-initdb.d/
        read_only: true
        
    network_mode: host
    restart: unless-stopped

  # REDIS - cache
  nextcloud-redis:
    image: redis:alpine
    container_name: nextcloud-redis
    hostname:       nextcloud-redis
    network_mode: host
    restart: unless-stopped

  # ------------------------------------------------------------
  # Nats
  nextcloud-nats:
    image: nats
    container_name: nextcloud-nats
    hostname:       nextcloud-nats
    network_mode: host
    restart: unless-stopped

  # Janus
  # https://hub.docker.com/r/sucwangsr/janus-webrtc-gateway-docker
  nextcloud-janus:
    image: sucwangsr/janus-webrtc-gateway-docker
    container_name: nextcloud-janus
    hostname:       nextcloud-janus
    command: ["/usr/local/bin/janus", "-F", "/usr/local/etc/janus"]
    volumes:
      - type: bind
        source: ./config/janus.jcfg
        target:  /usr/local/etc/janus/janus.jcfg
        read_only: true
    network_mode: host
    restart: unless-stopped

  # Turn
  # https://hub.docker.com/r/coturn/coturn
  nextcloud-turn:
    image: coturn/coturn:4.7.0-alpine
    container_name: nextcloud-turn
    hostname:       nextcloud-turn
    volumes:
      - type: bind
        source: ./config/turnserver.conf
        target:  /etc/coturn/turnserver.conf
        read_only: true
    network_mode: host
    restart: unless-stopped

  # Signal server
  # https://hub.docker.com/r/strukturag/nextcloud-spreed-signaling
  nextcloud-signaling:
    image: strukturag/nextcloud-spreed-signaling
    container_name: nextcloud-signaling
    hostname:       nextcloud-signaling
    environment:
      HTTP_LISTEN: 0.0.0.0:8080
      HASH_KEY:  $TOKEN
      BLOCK_KEY: $TOKEN
      INTERNAL_SHARED_SECRET_KEY: $TOKEN
      
      BACKENDS: "2"
      #BACKEND_1_URL: http://localhost
      #BACKEND_1_SHARED_SECRET: $TOKEN
      BACKEND_2_URL: http://payva-u.yooteam.ru:80
      BACKEND_2_SHARED_SECRET: $TOKEN
      
      USE_JANUS: 1
      JANUS_URL: ws://localhost:8188
      
      TURN_API_KEY: $TOKEN
      TURN_SECRET:  $TOKEN
      TURN_SERVERS: localhost:3478

    network_mode: host
    restart: unless-stopped


volumes:
  nextcloud-app-volume:
    name: nextcloud-app-volume
  nextcloud-postgres-volume:
    name: nextcloud-postgres-volume


networks:
  nextcloud:
    name:   nextcloud
    driver: bridge
